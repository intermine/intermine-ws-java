<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"
            type="text/javascript"></script>
        <script src="http://jquery-jsonp.googlecode.com/files/jquery.jsonp-2.1.4.min.js"
            type="text/javascript"></script>
        <script src="src/imbedding.js" type="text/javascript"></script>
        <script src="lib/jquery-ui-1.8.8.custom.min.js" type="text/javascript"></script>
        <script src="lib/jquery-syntax/jquery.syntax.js" type="text/javascript"></script>
        <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Merriweather' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Cabin:bold' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Neuton' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="lib/css/flick/jquery-ui-1.8.8.custom.css" />
        <link rel="stylesheet" type="text/css" href="lib/jquery-syntax/jquery.syntax.layout.list.css" />
        <link rel="stylesheet" type="text/css" href="lib/jquery-syntax/jquery.syntax.core.css" />
        <link rel="stylesheet" type="text/css" title="dark" href="style/style.css" />
        <link rel="alternate stylesheet" type="text/css" title="light" href="style/light.css" />
        <link rel="alternate stylesheet" type="text/css" title="glossy" href="style/glossy.css" />
        <link rel="stylesheet" type"text/css" href="style/tutorial.css"/>
    <head>
    <body>
        <div id="page">
        <h1 style="text-align: center;" >InterMine Mashup Tutorial</h1>
        <script type="text/javascript">
            availableTemplates = null;
            var baseUrl = "http://localhost:8080/intermine-test";
            $(function() {
                IMBedding.setBaseUrl(baseUrl);
                Syntax.root = "http://squirrel.flymine.org/imbedding/lib/jquery-syntax/";
                $('#showMeArea').syntax({
                    brush: 'javascript', 
                    layout: 'list', 
                    replace: true,
                    tabWidth: 4,
                    root: "lib/jquery-syntax/"
                    });
                $('#showMeAreaContainer').hide();

            });
            function setActiveStyleSheet(title) {
                var i, a, main;
                for(i=0; (a = document.getElementsByTagName("link")[i]); i++) {
                    if(a.getAttribute("rel").indexOf("style") != -1
                    && a.getAttribute("title")) {
                        a.disabled = true;
                        if(a.getAttribute("title") == title) a.disabled = false;
                    }
                }
            }

            function loadTable1() {
                IMBedding.loadTemplate(
                    {
                        name: "employeesOverACertainAgeFromDepartmentA",
                        size: 10,

                        constraint1: "Employee.age",
                        op1: ">=",
                        value1: 25,

                        constraint2: "Employee.department.name",
                        op2: "=",
                        value2: "DepartmentB1"

                    },
                    "#placeholder1"
                );
            }
            function loadTable2() {
                IMBedding.loadTemplate(
                    {
                        name: "employeesFromCompanyAndDepartment",
                        size: 10,

                        constraint1: "Employee.department.company.name",
                        op1: "LIKE",
                        value1: "Company*",

                        constraint2: "Employee.department.name",
                        op2: "LIKE",
                        value2: "Department*"
                    },
                    "#placeholder1"
                );
            }
            function loadTable3() {
                IMBedding.loadTemplate(
                    {
                        name: "employeesOfACertainAge",
                        size: 10,

                        constraint1: "Employee.age",
                        code1: "A",
                        op1: ">",
                        value1: 30,

                        constraint2: "Employee.age",
                        code2: "B",
                        op2: "<=",
                        value2: "60"
                    },
                    "#placeholder1"
                );
            }
            function loadTable4and5() {
                var xml = document.getElementById("xml-string").innerHTML;
                var data = {query: xml};
                IMBedding.loadQuery(data, "#placeholder2");
                IMBedding.loadQuery(data, "#placeholder3");
            }

            var firstline = "/* Below is the Javascript to load this table using ajax:\n"
                            + "You can cut and paste this into a page to get started.\n"
                            + "Don't forget you need to include the imbedding.js library"
                            + " in your head */\n\n";
                            + '/* You only need to do the following once once */' + "\n";
                            + "IMBedding.setBaseUrl('" + baseUrl + "');\n\n";

            function loadUserQuery(id) {
                var query = document.getElementById(id).value;
                var queryDisplayString;
                if (id.match(/json/)) {
                    queryDisplayString = query;
                    try {
                        query = eval( "(" + queryDisplayString + ")" );
                    } catch(err) {
                        alert("There is a problem with your json string:\n " + err);
                        return;
                    }
                } else {
                    queryDisplayString = "'" + query + "'";
                }
                var data = {size: 10};
                var newValue = firstline + "var query = " + queryDisplayString + ";\nIMBedding.loadQuery(query, {size: 10}, '#placeholder');";
                var codeContainer = $("#codeContainer");
                codeContainer.empty();

                var codeDisplayer = document.createElement("textarea");
                codeDisplayer.id = "codeDisplay";
                codeDisplayer.className = "coder";
                codeDisplayer.cols = 80;

                codeDisplayer.innerHTML = newValue;
                codeContainer.append(codeDisplayer);
                Syntax.root = "http://squirrel.flymine.org/imbedding/lib/jquery-syntax/";
                $(codeDisplayer).syntax({
                    brush: 'javascript', 
                    layout: 'list', 
                    replace: true,
                    tabWidth: 4,
                    root: "lib/jquery-syntax/"
                    });
                try {
                    IMBedding.loadQuery(query, data, "#placeholder2");
                } catch(err) {
                    alert("There was something wrong with your query:\n" + err);
                }
            }
            function complainAboutName(problem) {
                tempSpec = $('#templateSpecific');
                var error = document.createElement("p");
                error.className = "ui-state-error ui-corner-all";
                var icon = document.createElement("span");
                icon.className = "ui-icon ui-icon-alert";
                icon.style.float = "left";
                icon.style["margin-right"] = ".3em";
                error.appendChild(icon);
                var strong = document.createElement("strong");
                strong.innerHTML = "Um, excuse me:";
                error.appendChild(strong);
                error.appendChild(
                    document.createTextNode(" " + problem));
                tempSpec.prepend(error);
                return;
            }

            function loadUserTemplate() {
                var formValues = $('#template-form').serializeArray();
                if (! formValues[0].value) {
                  complainAboutName("Please enter a template name first");
                    return;
                    } else if (! (formValues[0].value in window.availableTemplates)) {
                    complainAboutName("Check the name - " + 
                        formValues[0].value + " is not one of the available templates");
                    return;
                }

                    
                var data = {size: 10};
                var newValue = firstline + "IMBedding.loadTemplate(\n\t{\n\t";
                for (x in formValues) {
                    name = formValues[x].name;
                    value = formValues[x].value;
                    data[name] = value;
                    if (name.match("constraint")) {
                        newValue += "\n\t";
                    }
                    newValue += "\t" +name + ":\t'" + value + "',\n\t";
                }
                newValue += "},\n\t'#placeholder'\n);";
                var codeContainer = $("#templateCodeContainer");
                codeContainer.empty();

                var codeDisplayer = document.createElement("textarea");
                codeDisplayer.id = "templateCodeDisplay";
                codeDisplayer.className = "coder";
                codeDisplayer.cols = 80;

                codeDisplayer.innerHTML = newValue;
                codeContainer.append(codeDisplayer);
                Syntax.root = "http://squirrel.flymine.org/imbedding/lib/jquery-syntax/";
                $(codeDisplayer).syntax({
                    brush: 'javascript', 
                    layout: 'list', 
                    replace: true,
                    tabWidth: 4,
                    root: "lib/jquery-syntax/"
                    });

                IMBedding.loadTemplate(data, '#placeholder3');
            };

            $(function() {
                $('#tabs').tabs();
            });
            $(function() {
                $("input:button").button();
                $("input:checkbox").button();
                $('#radio').buttonset();
                $('#styles').buttonset();
                $('#showMe').click(function() {
                    $('#showMeAreaContainer').slideToggle('fast', function() {});
                });
                $('#showTemplateCode').click(function() {
                    $('#templateCodeContainer').slideToggle('fast', function() {});
                });
                $('#showQueryCode').click(function() {
                    $('#codeContainer').slideToggle('fast', function() {});
                });
                $('input.styler').click(function() {
                    setActiveStyleSheet(this.id);
                });
                $('input.templater').click(function() {
                    if (this.id.match(/1/)) {
                        loadTable1();
                    } else if (this.id.match(/2/)) {
                        loadTable2();
                    } else if (this.id.match(/3/)) {
                        loadTable3();
                    }
                });
            });

            var operators = ["=", "!=", ">", "<", ">=", "<=", "LIKE", "LOOKUP"];
            getSelectHandler = function(templates) {
                return function(event, ui) {
                    if (ui.item) {
                        var selectedTemplate = ui.item.value;
                        tempSpec = $('#templateSpecific');
                        tempSpec.empty();
                        var template = templates[selectedTemplate];
                        var title = document.createElement("p");
                        title.innerHTML = template.title;
                        tempSpec.append(title);
                        var table = document.createElement("table");
                        for (var i = 0; i < template.constraints.length; i++) {
                            var row = document.createElement("tr");
                            table.appendChild(row);
                            cons = template.constraints[i];
                            counter = i + 1;

                            var cell1 = document.createElement("td");
                            var nameInput = document.createElement("input");
                            nameInput.type = "hidden";
                            nameInput.name = "constraint" + counter;
                            nameInput.value = cons.path;
                            cell1.appendChild(nameInput);
                            var label = document.createElement("label");
                            label["for"] = "op" + counter;
                            label.innerHTML = cons.path + ": ";
                            cell1.appendChild(label);
                            row.appendChild(cell1);

                            var cell2 = document.createElement("td");
                            var opInput = document.createElement("select");
                            opInput.name = "op" + counter;
                            for (var j = 0; j < operators.length; j++) {
                                var option = document.createElement("option");
                                option.value = operators[j];
                                option.innerHTML = operators[j];
                                if (operators[j] == cons.op) {
                                    option.selected = "selected";
                                }
                                opInput.appendChild(option);
                            }
                            cell2.appendChild(opInput);
                            row.appendChild(cell2);

                            var cell3 = document.createElement("td");
                            var valueInput = document.createElement("input");
                            valueInput.type = "text";
                            valueInput.name = "value" + counter;
                            valueInput.value = cons.value;
                            cell3.appendChild(valueInput);
                            var codeInput = document.createElement("input");
                            codeInput.type = "hidden";
                            codeInput.name = "code" + counter;
                            codeInput.value = cons.code;
                            cell3.appendChild(codeInput);
                            row.appendChild(cell3);

                        }
                        tempSpec.append(table);
                    }
                };
            };

            $(function() {
                $.jsonp({
                    url: "http://localhost:8080/intermine-test/service/templates",
                    callbackParameter: "callback",
                    data: {
                        format: "jsonp"
                    },
                    success: function( data ) {
                        window.availableTemplates = data;
                        var names = [];
                        for (name in data) {
                            names.push(name);
                        }
                        $('#templateName').autocomplete({
                            source: names,
                            select: getSelectHandler(availableTemplates),
                        });
                    }
                });
            });
        </script>

<div id="tabs">
    <form>
        <div id="styles" style="float: right;">
            <input class="styler" type="radio" id="dark" name="style" checked="true"/>
                <label for="dark">Dark</label>
            <input class="styler" type="radio" id="light" name="style"/>
                <label for="light">Light</label>
            <input class="styler" type="radio" id="glossy" name="style"/>
                <label for="glossy">Glossy</label>
        </div>
    </form>
    <ul>
        <li><a href="#tabs-1">Automatic Loading</a></li>
        <li><a href="#tabs-2">Loading Arbitrary Queries</a></li>
        <li><a href="#tabs-3">Loading Templates</a></li>
    </ul>


    <div id="tabs-1">
        <h2>Loading a template automatically</h2>
        <p> 
            Results can be loaded in automatically on page ready or any other event. Here, three
            queries are bound to button click events. Click on the names of the templates 
            to load the corresponding data.
        </p><p>
            Click on the other two tabs to see how you can code this behaviour yourself.
        </p>
        <div class="option-box">
        <form>
            <span style="float: right"><input type="checkbox" id="showMe" /><label for="showMe">Show/Hide the code</label></span>
            <div id="radio">
                <input class="templater" type="radio" id="template1" name="template"/><label for="template1">Template 1</label>
                <input class="templater" type="radio" id="template2" name="template"/><label for="template2">Template 2</label>
                <input class="templater" type="radio" id="template3" name="template"/><label for="template3">Template 3</label>
            </div>
        </form>
        <div id="showMeAreaContainer" style="display: none;">
        <textarea rows="20" cols="80" id="showMeArea" class="coder">
// for page load: 
// See the other tabs for how to write the function
$(function() {loadTemplate();}); 

// for button click
$('#button').click(function() {loadTemplate();});
</textarea>
        </div>
        </div>
        <div id="placeholder1"><p>This will be where the table goes</p></div>
    </div>

    <div id="tabs-2">
        <h2>Loading an arbitrary Query</h2>
        <p> 
            Queries can be passed to the loading function as either an xml text string,
            or as a json object. The loading module must be prepared with the base url
            before-hand in either case. 
        </p><p>
            You can edit the xml/json in the two boxes, and then press load to see the effect, 
            and how to put that into your own code. You can find information on the 
            xml format <a href="http://www.intermine.org/wiki/QueryXmlFormat">here</a>. 
            The json object format is basically the same, except that its view is expected
            to be an array and it has arrays of "joins" and "constraints" in the place of 
            the repeated xml tags. Also: it accepts "from" as a synonym for "model", 
            "where" as a synonym for "constraints", and "select" as a synonym for 
            "view" (as in the example below)
        </p>
        <div class="option-box">
            <table><tr>
            <td colspan="2"> 
<div id="codeContainer" style="display: none">
<div id="codeDisplay" class="ui-state-highlight ui-corner-all">
    <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><strong>Patience please</strong> - there isn't any code to display just yet.</p>
</div>
</div>
            </td>
            </tr><tr>
            <td>
                <textarea id="xml-query" rows="13" cols="45" class="coder">
<query model="testmodel" view="Employee.name Employee.age Employee.department.manager.name Employee.department.company.name">
    <constraint path="Employee.age" code="A" op=">" value="30"/>
</query></textarea>
                <br/>
                <input type="button" value="load query from xml" onclick="loadUserQuery('xml-query')"></input>
            </td>
            <td>
                <textarea id="json-query" rows="13" cols="45" class="coder">
{
  select: [
    "Employee.name", "Employee.age", 
    "Employee.department.manager.name", 
    "Employee.department.company.name"
  ],
  from: 'testmodel',
  where: [
    {path: "Employee.age", op: ">", value: 30}
  ]
}</textarea>
                <br/>
                <input type="button" value="load query from json" onclick="loadUserQuery('json-query')"></input>
                <input type="checkbox" id="showQueryCode"/><label for="showQueryCode">Show / Hide the code</label>
            </td>
    </tr></table>
            
            <div id="placeholder2"><p>The query defined in the box above will go here</p></div>
        </div>
    </div>

    <div id="tabs-3">
        <h2>Loading a template</h2>
        <div class="option-box">
            <form id="template-form">
                <label for="templateName">Template Name: </label>
                <input size="50" type="text" name="name" id="templateName" placeholder="Enter a template Name"></input>
                <div id="templateSpecific"></div>
                <input type="button" name="loadTemplate" value="Load Template" onclick="loadUserTemplate()"></input>
                <input type="checkbox" id="showTemplateCode"/><label for="showTemplateCode">Show / Hide the code</label>
            </form>
            <div id="templateCodeContainer" style="display: none">
                <div id="templateCodeDisplay"  class="ui-state-highlight ui-corner-all">
    <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><strong>Patience please</strong> - there isn't any code to display just yet.</p>
            </div>
            </div>
        </div>
        <div id="placeholder3"><p>The template results will go here</p></div>
    </div>
</div>

        <div id="xml-string" style="display: none;">
            <query name="employeesOfACertainAge" model="testmodel" 
                view="Employee.name Employee.age" >
                <constraint path="Employee.age" code="A" editable="true" 
                description="First age constraint" op="&gt;" value="30"></constraint>
                <constraint path="Employee.age" code="B" editable="true" 
                    description="Second age constraint" op="&lt;=" value="60"/></constraint>
            </query>
        </div>
    </div>
    </body>
</html>
